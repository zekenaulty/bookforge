{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://bookforge.local/schemas/prompt_composition/manifest.schema.json",
  "title": "BookForge Prompt Composition Manifest",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "template",
    "entries"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0"
    },
    "template": {
      "type": "string",
      "pattern": "^[a-z0-9_]+\\.md$"
    },
    "entries": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/manifest_entry"
      }
    }
  },
  "$defs": {
    "source_prompt_span": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "line_start",
        "line_end"
      ],
      "properties": {
        "line_start": {
          "type": "integer",
          "minimum": 1
        },
        "line_end": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "repeat_policy": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "repeat_count"
      ],
      "properties": {
        "repeat_count": {
          "type": "integer",
          "minimum": 1
        },
        "justification": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "manifest_entry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "entry_id",
        "semantic_id",
        "source_path",
        "source_prompt_span",
        "owner_phase",
        "applies_to",
        "guard_level",
        "risk_class",
        "dedupe_eligible",
        "repeat_policy"
      ],
      "properties": {
        "entry_id": {
          "type": "string",
          "minLength": 1
        },
        "semantic_id": {
          "type": "string",
          "minLength": 1
        },
        "source_path": {
          "type": "string",
          "pattern": "^resources/prompt_blocks/.+\\.md$"
        },
        "source_prompt_span": {
          "$ref": "#/$defs/source_prompt_span"
        },
        "owner_phase": {
          "type": "string",
          "enum": [
            "system",
            "outline",
            "plan",
            "preflight",
            "write",
            "repair",
            "state_repair",
            "lint",
            "continuity_pack",
            "characters_generate",
            "author_generate",
            "appearance_projection",
            "style_anchor",
            "output_contract"
          ]
        },
        "applies_to": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "pattern": "^[a-z0-9_]+\\.md$"
          }
        },
        "guard_level": {
          "type": "string",
          "enum": [
            "guarded",
            "soft"
          ]
        },
        "risk_class": {
          "type": "string",
          "enum": [
            "low",
            "medium",
            "high",
            "critical"
          ]
        },
        "dedupe_eligible": {
          "type": "boolean"
        },
        "repeat_policy": {
          "$ref": "#/$defs/repeat_policy"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "repeat_policy": {
                "properties": {
                  "repeat_count": {
                    "minimum": 2
                  }
                },
                "required": [
                  "repeat_count"
                ]
              }
            }
          },
          "then": {
            "properties": {
              "repeat_policy": {
                "required": [
                  "justification"
                ]
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "guard_level": {
                "const": "guarded"
              },
              "repeat_policy": {
                "properties": {
                  "repeat_count": {
                    "minimum": 2
                  }
                },
                "required": [
                  "repeat_count"
                ]
              }
            }
          },
          "then": {
            "properties": {
              "repeat_policy": {
                "required": [
                  "justification"
                ]
              }
            }
          }
        }
      ]
    }
  }
}
