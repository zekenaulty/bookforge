{
  "label": "plan_scene",
  "created_at": "2026-01-27T03:22:43Z",
  "provider": "dummy",
  "model": "dummy",
  "text": "{\"schema_version\": \"1.1\", \"scene_id\": \"SC_001_001\", \"chapter\": 1, \"scene\": 1, \"scene_target\": \"The call arrives.\", \"goal\": \"Force a decision.\", \"conflict\": \"A warning complicates the offer.\", \"required_callbacks\": [], \"constraints\": [], \"end_condition\": \"The hero commits.\"}",
  "raw": {
    "candidates": [
      {
        "finishReason": "STOP"
      }
    ]
  },
  "request": {
    "model": "dummy",
    "temperature": 0.4,
    "max_tokens": 32768
  },
  "extra": {
    "book_id": "my_book",
    "chapter": 1,
    "scene": 1
  },
  "prompt": {
    "system": "# BookForge System Prompt\n\n## Base Rules\n\nYou are BookForge, a deterministic book-writing engine.\nFollow the output contracts exactly.\nYOU MUST ALWAYS RETURN THE REQUESTED CONTENT OR AN ERROR RESPONSE JSON RESULT.\nTreat all schema requirements and numeric ranges as hard constraints.\nIf a prompt specifies required counts or ranges, you must satisfy them.\nIf a prompt requires multiple output blocks, include all blocks in order.\nIf registries or ids are provided, use only those; do not invent new ids.\nIf constraints conflict, prioritize: output format/schema, numeric ranges, task rules, style.\nTimeline Lock: You may only depict events explicitly listed in the current Scene Card. You must not depict, imply, or resolve any later-scene milestone outcomes (including acquisition, binding, reveals, travel arrival, injury changes) unless the Scene Card explicitly contains that milestone.\nState primacy: state invariants and summary facts are binding; do not contradict them.\nMilestone uniqueness: if a milestone is marked DONE in state/must_stay_true, you must not depict it happening again. If marked NOT_YET, you must not depict it happening now.\nSpatial/inventory consistency: injuries, inventory, and ownership must remain consistent unless explicitly changed in the Scene Card.\nInventory contract: track item ownership and container location per character or container label; items do not teleport.\nInventory location: for held items, specify hand_left or hand_right; for stowed items, specify container label.\nState contract: you must create and maintain key state data each scene. summary_update and must_stay_true are required outputs and binding facts for future scenes.\nInvariant carry-forward: if an invariant still holds, restate it in must_stay_true; do not drop it.\nConflict rule: if scene intent conflicts with state invariants, invariants win; return an ERROR JSON if you cannot comply.\nNever recap at scene openings.\nDo not repeat previous prose.\n\n## Book Constitution\n\nTitle: Untitled\nBook ID: my_book\nAuthor Ref: eldrik-vale/v1\nGenre: fantasy\nSeries ID: my_book\nSeries Ref: series/my_book\n\nVoice\n- POV: third_limited\n- Tense: past\n- Style tags: no-recaps, forward-motion, tight-prose\n\nTargets\n- chapters: 1\n\nPage Metrics\n- Words per page: 250\n- Chars per page: 1500\n\nInvariants\n- No world resets.\n- No convenient amnesia as a continuity device.\n- Do not change established names/relationships.\n\n## Author Persona\n\nAuthor fragment.\n\n## Output Contract\n\nOutput must follow the requested format.\nJSON blocks must be valid and schema-compliant.\nAll required keys and arrays must be present.\nWhen a prompt specifies required counts or ranges, treat them as hard constraints.\nDo not collapse arrays below the stated minimums.\nIf multiple output blocks are required (e.g. PROSE and STATE_PATCH), include all blocks in order.\nIf output must be JSON only, return a single JSON object with no commentary or code fences.\nWhen creating outlines, the total scenes per chapter (sum of sections[].scenes[]) must match chapters[].pacing.expected_scene_count.\nIf a prompt requires a COMPLIANCE or PREFLIGHT block, include it before PROSE.\n",
    "messages": [
      {
        "role": "user",
        "content": "# PLAN\n\nYou are the planner. Use the outline window and state to create the next scene card.\nReturn ONLY a single JSON object that matches the scene_card schema.\nNo markdown, no code fences, no commentary. Use strict JSON (double quotes, no trailing commas).\n\nIf outline_window includes character information, keep those character ids in mind.\nIf character_states are provided, keep inventory/persona constraints consistent; do not invent conflicting facts.\nIf outline_window.current.introduces is present, the scene must introduce those characters.\n\nRequired keys:\n- schema_version (\"1.1\")\n- scene_id\n- chapter\n- scene\n- scene_target\n- goal\n- conflict\n- required_callbacks (array)\n- constraints (array)\n- end_condition\n\nRecommended keys (use ids from the outline; do not invent ids):\n- cast_present (array of character names for prose guidance)\n- cast_present_ids (array of character ids, e.g. CHAR_Eldrin)\n- introduces (array of character names introduced in this scene)\n- introduces_ids (array of character ids introduced in this scene)\n- thread_ids (array of thread ids, e.g. THREAD_Awakened_Sage)\n\nJSON shape example (fill with real values):\n{\n  \"schema_version\": \"1.1\",\n  \"scene_id\": \"SC_001_001\",\n  \"chapter\": 1,\n  \"scene\": 1,\n  \"scene_target\": \"Protagonist commits to the journey.\",\n  \"goal\": \"Force a decisive choice.\",\n  \"conflict\": \"Safety versus obligation.\",\n  \"required_callbacks\": [],\n  \"constraints\": [\"target_words: 1900\"],\n  \"end_condition\": \"The protagonist leaves home.\",\n  \"cast_present\": [\"Eldrin\"],\n  \"cast_present_ids\": [\"CHAR_Eldrin\"],\n  \"introduces\": [],\n  \"introduces_ids\": [],\n  \"thread_ids\": [\"THREAD_Awakened_Sage\"]\n}\n\nOutline window:\n{\n  \"chapter\": {\n    \"bridge\": {\n      \"from_prev\": \"\",\n      \"to_next\": \"A decision is forced.\"\n    },\n    \"chapter_id\": 1,\n    \"chapter_role\": \"hook\",\n    \"characters\": [\n      \"CHAR_new_character_name\"\n    ],\n    \"goal\": \"Introduce the quest.\",\n    \"pacing\": {\n      \"expected_scene_count\": 1,\n      \"intensity\": 3,\n      \"tempo\": \"steady\"\n    },\n    \"stakes_shift\": \"The call arrives.\",\n    \"title\": \"Opening\"\n  },\n  \"current\": {\n    \"callbacks\": [],\n    \"characters\": [\n      \"CHAR_new_character_name\"\n    ],\n    \"introduces\": [],\n    \"outcome\": \"The hero is summoned.\",\n    \"scene_id\": 1,\n    \"section\": {\n      \"intent\": \"Present the summons.\",\n      \"section_id\": 1,\n      \"section_role\": \"\",\n      \"title\": \"Arrival\"\n    },\n    \"summary\": \"The call arrives.\",\n    \"threads\": [],\n    \"type\": \"setup\"\n  },\n  \"next\": null,\n  \"previous\": null,\n  \"scene_index\": 1,\n  \"section\": {\n    \"intent\": \"Present the summons.\",\n    \"section_id\": 1,\n    \"section_role\": \"\",\n    \"title\": \"Arrival\"\n  }\n}\n\n\nCharacter states (per outline_window.current.characters):\n[\n  {\n    \"character_id\": \"CHAR_new_character_name\",\n    \"missing\": true\n  }\n]\n\nState:\n{\n  \"budgets\": {\n    \"max_new_entities\": 1,\n    \"max_new_threads\": 1,\n    \"max_scene_words\": 0,\n    \"min_scene_words\": 0\n  },\n  \"cursor\": {\n    \"chapter\": 0,\n    \"scene\": 0\n  },\n  \"duplication_warnings_in_row\": 0,\n  \"schema_version\": \"1.0\",\n  \"status\": \"NEW\",\n  \"summary\": {\n    \"chapter_so_far\": [],\n    \"key_facts_ring\": [],\n    \"last_scene\": [],\n    \"must_stay_true\": [],\n    \"pending_story_rollups\": [],\n    \"story_so_far\": []\n  },\n  \"world\": {\n    \"cast_present\": [],\n    \"location\": \"\",\n    \"open_threads\": [],\n    \"recent_facts\": [],\n    \"time\": {}\n  }\n}\n\nTask:\nCreate the next scene card.\n"
      }
    ]
  }
}